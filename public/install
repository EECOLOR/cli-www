#!/bin/bash

filter_tag() {
  xargs basename
}

filter_location() {
  awk '/Location:/{print $2}' | tr -d '\r' 
}

curl_head() {
  curl --head --silent "$@"
}

wget_head() {
  wget --server-response --quiet --output-document=/dev/null "$@" 2>&1
}

ask_github() {
  head https://github.com/exercism/cli/releases/latest
}

latest() {
  ask_github | filter_location | filter_tag
}

VERSION="$(latest)"

archive_os() {
  if [ "$(uname -s)" == "Darwin" ]; then
    echo "darwin"
  else
    echo "linux"
  fi
}

archive_arch() {
  if [ "$(uname -m)" == "x86_64" ]; then
    echo "amd64"
  else
    echo "i386"
  fi
}

archive() {
  echo "exercism-$(archive_os)-$(archive_arch).tgz"
}

FILE="$(archive)"

cd /tmp

URL=https://github.com/exercism/cli/releases/download/$VERSION/$FILE

if type curl &>/dev/null; then
  curl -LOk $URL
elif type wget &>/dev/null; then
  wget $URL
else
  echo "error: please install \`curl\` or \`wget\` and try again" >&2
  exit 1
fi

if [ $? != 0 ]; then
  echo "Unable to download $URL"
  exit 1
fi

tar zxvf $FILE

if [ $? != 0 ]; then
  echo "Failed to unpack $FILE"
  exit 1
fi

if [ -d /usr/local/bin ]; then
  if [ -w /usr/local/bin ]; then
    mv exercism /usr/local/bin/
  fi
fi

if [ ! -f /usr/local/bin/exercism ]; then
  # OK. Trying something else.
  # This might be considered slightly impolite.
  if [ ! -d $HOME/bin ]; then
    mkdir $HOME/bin
  fi
  mv exercism $HOME/bin/

  if [ $? != 0 ]; then
    echo "Unable to figure out where to put the binary"
    echo "Please submit an issue so we can improve the script: https://github.com/exercism/cli-www/issues"
    exit 1
  fi
fi

if [ ! $(echo $PATH | grep "$HOME/bin") ]; then
  if [ ! $(echo $PATH | grep "~/bin") ]; then
    # Add ~/bin to the PATH
    if [ -f $HOME/.bash_profile ]; then
      echo 'export PATH=$HOME/bin:$PATH' >> $HOME/.bash_profile
    fi
    if [ -f $HOME/.zshrc ]; then
      echo 'export PATH=$HOME/bin:$PATH' >> $HOME/.zshrc
    fi
  fi
fi
